<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🏠 Οικογενειακές Εργασίες</title>

  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#2e7d82"/>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

  <style>
    /* …(όλα όπως πριν, δεν αλλάζω τα styles)… */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:800px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.2);overflow:hidden}
    .login-container{padding:50px;text-align:center;min-height:500px;display:flex;flex-direction:column;justify-content:center}
    .login-title{font-size:2.5em;color:#2e7d82;margin-bottom:30px}
    .user-buttons{display:grid;gap:15px;margin-bottom:30px}
    .user-btn{padding:15px 25px;border:none;border-radius:15px;font-size:18px;cursor:pointer;background:linear-gradient(135deg,#2e7d82 0%,#3d8b8f 100%);color:#fff;transition:.3s}
    .user-btn:hover{transform:translateY(-2px)}
    .user-btn.selected{background:linear-gradient(135deg,#28a745 0%,#20c997 100%)}
    .pin-input{width:100%;padding:20px;font-size:24px;text-align:center;border:3px solid #2e7d82;border-radius:15px;margin-bottom:20px;letter-spacing:10px;outline:0}
    .header{background:linear-gradient(135deg,#2e7d82 0%,#3d8b8f 100%);padding:30px;color:#fff;text-align:center}
    .header h1{font-size:2.2em;margin-bottom:10px}
    .user-info{display:flex;justify-content:space-between;align-items:center;margin-top:20px}
    .current-user{font-size:18px;font-weight:600}
    .header-buttons{display:flex;gap:10px}
    .btn-header{padding:8px 15px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.3);border-radius:20px;color:#fff;font-size:14px;cursor:pointer}
    .admin-badge{background:#ffd700;color:#333;padding:5px 10px;border-radius:15px;font-size:12px;font-weight:bold;margin-left:10px}
    .main-content{padding:30px}
    .stats{display:flex;justify-content:space-around;background:#f8f9fa;padding:20px;border-radius:15px;margin-bottom:30px}
    .stat-item{text-align:center}
    .stat-number{font-size:2em;font-weight:bold;color:#2e7d82}
    .stat-label{color:#666;font-size:14px}
    .tabs{display:flex;background:#f8f9fa;border-radius:15px;padding:5px;margin-bottom:30px}
    .tab{flex:1;padding:12px 20px;text-align:center;border-radius:10px;cursor:pointer;font-weight:600;color:#666;font-size:14px;transition:.3s}
    .tab.active{background:linear-gradient(135deg,#2e7d82 0%,#3d8b8f 100%);color:#fff;transform:translateY(-2px)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .btn{background:linear-gradient(135deg,#2e7d82 0%,#3d8b8f 100%);color:#fff;border:none;padding:12px 30px;border-radius:25px;font-size:16px;cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-2px)}
    .btn-small{padding:8px 15px;font-size:14px}
    .btn-success{background:#28a745}
    .btn-danger{background:#dc3545}
    .btn-warning{background:#ffc107;color:#333}
    .btn-secondary{background:#6c757d}
    .task-form{background:#f8f9fa;padding:25px;border-radius:15px;margin-bottom:30px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#2e7d82}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px 15px;border:2px solid #e9ecef;border-radius:10px;font-size:16px}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:0;border-color:#2e7d82}
    .form-group input[type="file"]{border:2px dashed #2e7d82;background:#f8f9fa;padding:20px;text-align:center;cursor:pointer}
    .photo-preview{max-width:200px;border-radius:10px}
    .task-photo{max-width:100%;border-radius:10px;margin-top:10px}
    .tasks-section h3{color:#2e7d82;margin-bottom:20px;font-size:1.5em}
    .task-item{background:#fff;border:2px solid #e9ecef;border-radius:15px;padding:20px;margin-bottom:15px;transition:.2s}
    .task-item:hover{transform:translateY(-2px)}
    .task-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .task-title{font-size:1.2em;font-weight:600;color:#2e7d82}
    .task-status{padding:5px 15px;border-radius:20px;font-size:12px;font-weight:bold}
    .status-pending{background:#fff3cd;color:#856404}
    .status-completed{background:#d1ecf1;color:#0c5460}
    .task-meta{display:flex;gap:20px;margin-bottom:10px;font-size:14px;color:#666;flex-wrap:wrap}
    .task-description{margin-bottom:15px;line-height:1.6}
    .task-actions{display:flex;gap:10px;flex-wrap:wrap}
    .loading{display:flex;justify-content:center;align-items:center;height:200px}
    .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #2e7d82;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .notification-panel{position:fixed;top:20px;right:20px;background:#2e7d82;color:#fff;padding:15px 20px;border-radius:10px;z-index:1000;animation:slideIn .3s ease-out;max-width:300px}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .notification-close{background:none;border:none;color:#fff;float:right;cursor:pointer;font-size:18px;margin-left:10px}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
    .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:20px;padding:40px;max-width:400px;width:90%}
    .modal h3{color:#2e7d82;margin-bottom:20px;text-align:center}
    .error{color:#dc3545;font-size:14px;margin-top:5px}
    @media (max-width:768px){
      .container{margin:10px}
      .header{padding:20px}
      .header h1{font-size:2em}
      .main-content,.login-container{padding:20px}
      .user-info{flex-direction:column;gap:10px}
      .task-meta{flex-direction:column;gap:5px}
      .task-actions{flex-direction:column}
    }
  </style>
</head>
<body>
  <!-- *** UI όπως πριν (login, tabs, φόρμες κ.λπ.) *** -->
  <div class="container">
    <!-- loginScreen ... -->
    <!-- appScreen ... -->
    <!-- (το UI μένει ίδιο με πριν) -->
  </div>

  <div id="pinModal" class="modal">
    <div class="modal-content">
      <h3>🔑 Διαχείριση PIN</h3>
      <div id="pinManagementContent"></div>
      <div style="text-align:center;margin-top:20px;">
        <button class="btn btn-secondary" onclick="closePinModal()">Ακύρωση</button>
      </div>
    </div>
  </div>

  <script>
    // --- Firebase config (ίδιο) ---
    const firebaseConfig = {
      apiKey: "AIzaSyC1FnOEYHlBaXQtxqHX9Qnwx4lpZc0cZY0",
      authDomain: "family-tasks-app-44296.firebaseapp.com",
      projectId: "family-tasks-app-44296",
      storageBucket: "family-tasks-app-44296.firebasestorage.app",
      messagingSenderId: "108479351489",
      appId: "1:108479351489:web:0629b17053ec0eeb96e240"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Messaging / VAPID ---
    let messaging = null;
    let fcmServiceWorkerRegistration = null;

    // Public VAPID KEY (σωστό, αυτό με BA…)
    const PUBLIC_VAPID_KEY = 'BA6EmgZjlUi3lgc8lVjqk4gtMFb5hLqg9UzsUmWwuuRRCg5GPBYfWP54kBpTggvUpj-CE_3bG2SKPA9aEGOrtNI';

    // --- App state (ίδιο) ---
    let currentUser = null, currentUserId = null, isAdmin = false, tasks = [], users = {}, notificationsEnabled = false, taskFormVisible = false;
    const userNames = { dad:'👨 Άρης', mom:'👩 Κατερίνα', child:'👧 Ελισάβετ' };
    const priorityColors = { low:'#28a745', medium:'#ffc107', high:'#dc3545' };
    const defaultPins = { dad:'1234', mom:'5678', child:'9999' };

    // ---------- ΝΕΟ: Γράφουμε SW νωρίς ----------
    async function registerSwEarly(){
      if (!('serviceWorker' in navigator)) return;
      if (fcmServiceWorkerRegistration) return;
      try{
        fcmServiceWorkerRegistration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log('FCM SW registered (early)');
      }catch(e){
        console.error('FCM SW early registration failed', e);
      }
    }
    // ---------------------------------------------

    document.addEventListener('DOMContentLoaded', function(){
      registerSwEarly(); // <— ΝΕΟ: γράφεται ο SW από νωρίς
      checkStoredLogin();
      initializeUsers();
      setupEventListeners();
    });

    function checkStoredLogin(){
      const storedUser = localStorage.getItem('familyTasksUser');
      const storedLoginTime = localStorage.getItem('familyTasksLoginTime');
      if(storedUser && storedLoginTime){
        const daysSinceLogin = (new Date()-new Date(storedLoginTime))/(1000*60*60*24);
        if(daysSinceLogin<30){
          currentUser = storedUser;
          currentUserId = storedUser;
          db.collection('users').doc(storedUser).get().then(doc=>{
            if(doc.exists){
              isAdmin = doc.data().isAdmin || false;
              showApp();
              loadTasks();
              setupNotifications();
              if(isAdmin) showAdminFeatures();
            }
          });
          return;
        }
      }
      document.getElementById('loginScreen').style.display='block';
    }

    // …[ΟΛΕΣ οι υπόλοιπες συναρτήσεις σου μένουν ίδιες: initializeUsers, loadUsers, login, UI, tasks, κ.λπ.]…

    // ---------- FCM Web Push ----------
    async function setupNotifications(){
      if(!('Notification' in window) || !('serviceWorker' in navigator)) return;

      try{
        // Αν για κάποιο λόγο δεν γράφτηκε ήδη, γράψ' τον τώρα
        if(!fcmServiceWorkerRegistration){
          fcmServiceWorkerRegistration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          console.log('FCM SW registered');
        }
      }catch(err){
        console.error('FCM SW registration failed', err);
        return;
      }

      messaging = firebase.messaging();

      if(Notification.permission === 'granted'){
        notificationsEnabled = true;
        await getAndSaveFcmToken();
        messaging.onMessage(payload=>{
          const n = payload.notification || {};
          showNotification(`${n.title || 'Ειδοποίηση'}\n${n.body || ''}`);
        });
      }else if(Notification.permission !== 'denied'){
        const btn = document.getElementById('enableNotificationsBtn');
        if (btn) btn.style.display='inline-block';
      }
    }

    async function enableNotifications(){
      try{
        const permission = await Notification.requestPermission();
        if(permission==='granted'){
          notificationsEnabled = true;
          const btn = document.getElementById('enableNotificationsBtn');
          if (btn) btn.style.display='none';
          showNotification('🔔 Οι ειδοποιήσεις ενεργοποιήθηκαν!');
          await getAndSaveFcmToken();
          messaging.onMessage(payload=>{
            const n = payload.notification || {};
            showNotification(`${n.title || 'Ειδοποίηση'}\n${n.body || ''}`);
          });
        }else{
          showNotification('❌ Οι ειδοποιήσεις απορρίφθηκαν');
        }
      }catch(err){
        console.error('Error enabling notifications:', err);
        showNotification('❌ Σφάλμα ενεργοποίησης ειδοποιήσεων');
      }
    }

    async function getAndSaveFcmToken(){
      try{
        const token = await messaging.getToken({
          vapidKey: PUBLIC_VAPID_KEY,
          serviceWorkerRegistration: fcmServiceWorkerRegistration
        });
        console.log('FCM token =>', token);
        if(token && currentUser){
          await db.collection('users').doc(currentUser).set({ fcmToken: token }, { merge: true });
          showNotification('✅ Token αποθηκεύτηκε.');
        }else{
          showNotification('ℹ️ Δεν ελήφθη token (άδεια/AdBlock?).');
        }
      }catch(err){
        console.error('FCM getToken error:', err);
        showNotification('❌ FCM token error: ' + (err.code||'') + ' ' + (err.message||err));
      }
    }
    // ----------------------------------

    function sendTaskNotification(targetUser, title, message){
      db.collection('notifications').add({
        targetUser, fromUser: currentUser, title, message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(), read:false
      });
    }

    function listenForNotifications(){
      if(!currentUser) return;
      db.collection('notifications').where('targetUser','==',currentUser).where('read','==',false)
      .onSnapshot(snapshot=>{
        snapshot.docChanges().forEach(change=>{
          if(change.type==='added'){
            const n = change.doc.data();
            showNotification(`${n.title}\n${n.message}`);
            db.collection('notifications').doc(change.doc.id).update({ read:true });
          }
        });
      });
    }

    function openPinModal(){ document.getElementById('pinModal').style.display='block'; if(isAdmin){ loadAdminPinManagement(); } else { loadUserPinManagement(); } }
    function closePinModal(){ document.getElementById('pinModal').style.display='none'; }

    function loadUserPinManagement(){
      document.getElementById('pinManagementContent').innerHTML = `
        <div class="form-group"><label>Τρέχον PIN</label><input type="password" id="currentPin" placeholder="Εισάγετε το τρέχον PIN"></div>
        <div class="form-group"><label>Νέο PIN</label><input type="password" id="newPin" placeholder="Εισάγετε το νέο PIN" maxlength="6"></div>
        <div class="form-group"><label>Επιβεβαίωση νέου PIN</label><input type="password" id="confirmPin" placeholder="Επιβεβαιώστε το νέο PIN" maxlength="6"></div>
        <div class="error" id="pinError"></div>
        <button class="btn" onclick="changeUserPin()" style="width:100%;margin-top:10px;">🔑 Αλλαγή PIN</button>`;
    }

    function loadAdminPinManagement(){
      document.getElementById('pinManagementContent').innerHTML = `
        <div class="form-group"><label>Επιλέξτε χρήστη</label><select id="pinUser"><option value="dad">👨 Άρης</option><option value="mom">👩 Κατερίνα</option><option value="child">👧 Ελισάβετ</option></select></div>
        <div class="form-group"><label>Νέο PIN</label><input type="password" id="adminNewPin" placeholder="Εισάγετε το νέο PIN" maxlength="6"></div>
        <div class="form-group"><label>Επιβεβαίωση PIN</label><input type="password" id="adminConfirmPin" placeholder="Επιβεβαιώστε το νέο PIN" maxlength="6"></div>
        <div class="error" id="adminPinError"></div>
        <button class="btn" onclick="changeUserPinAsAdmin()" style="width:100%;margin-top:10px;">⚙️ Αλλαγή PIN Χρήστη</button>
        <hr style="margin:30px 0;">
        <div class="form-group"><label>Αλλαγή του δικού μου PIN</label><input type="password" id="adminCurrentPin" placeholder="Τρέχον PIN"></div>
        <div class="form-group"><input type="password" id="adminMyNewPin" placeholder="Νέο PIN" maxlength="6"></div>
        <div class="form-group"><input type="password" id="adminMyConfirmPin" placeholder="Επιβεβαίωση νέου PIN" maxlength="6"></div>
        <button class="btn btn-warning" onclick="changeAdminPin()" style="width:100%;margin-top:10px;">🔑 Αλλαγή δικού μου PIN</button>`;
    }

    async function changeUserPin(){
      const currentPin = document.getElementById('currentPin').value;
      const newPin = document.getElementById('newPin').value;
      const confirmPin = document.getElementById('confirmPin').value;
      if(!currentPin || !newPin || !confirmPin){ showError('pinError','Συμπληρώστε όλα τα πεδία'); return; }
      if(newPin !== confirmPin){ showError('pinError','Τα PIN δεν ταιριάζουν'); return; }
      if(newPin.length<4){ showError('pinError','Το PIN πρέπει να έχει τουλάχιστον 4 ψηφία'); return; }
      try{
        const userDoc = await db.collection('users').doc(currentUser).get();
        const userData = userDoc.data();
        if(userData.pin !== currentPin){ showError('pinError','Λάθος τρέχον PIN'); return; }
        await db.collection('users').doc(currentUser).update({ pin:newPin, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        closePinModal(); showNotification('🔑 Το PIN σας άλλαξε επιτυχώς!');
      }catch(err){ console.error('Error changing PIN:', err); showError('pinError','Σφάλμα αλλαγής PIN'); }
    }

    async function changeUserPinAsAdmin(){
      const userId = document.getElementById('pinUser').value;
      const newPin = document.getElementById('adminNewPin').value;
      const confirmPin = document.getElementById('adminConfirmPin').value;
      if(!newPin || !confirmPin){ showError('adminPinError','Συμπληρώστε όλα τα πεδία'); return; }
      if(newPin !== confirmPin){ showError('adminPinError','Τα PIN δεν ταιριάζουν'); return; }
      if(newPin.length<4){ showError('adminPinError','Το PIN πρέπει να έχει τουλάχιστον 4 ψηφία'); return; }
      try{
        await db.collection('users').doc(userId).update({ pin:newPin, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        closePinModal(); showNotification(`🔑 Το PIN του/της ${userNames[userId]} άλλαξε επιτυχώς!`);
      }catch(err){ console.error('Error changing user PIN:', err); showError('adminPinError','Σφάλμα αλλαγής PIN'); }
    }

    async function changeAdminPin(){
      const currentPin = document.getElementById('adminCurrentPin').value;
      const newPin = document.getElementById('adminMyNewPin').value;
      const confirmPin = document.getElementById('adminMyConfirmPin').value;
      if(!currentPin || !newPin || !confirmPin){ showError('adminPinError','Συμπληρώστε όλα τα πεδία'); return; }
      if(newPin !== confirmPin){ showError('adminPinError','Τα PIN δεν ταιριάζουν'); return; }
      if(newPin.length<4){ showError('adminPinError','Το PIN πρέπει να έχει τουλάχιστον 4 ψηφία'); return; }
      try{
        const userDoc = await db.collection('users').doc(currentUser).get();
        const userData = userDoc.data();
        if(userData.pin !== currentPin){ showError('adminPinError','Λάθος τρέχον PIN'); return; }
        await db.collection('users').doc(currentUser).update({ pin:newPin, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        closePinModal(); showNotification('🔑 Το PIN σας άλλαξε επιτυχώς!');
      }catch(err){ console.error('Error changing admin PIN:', err); showError('adminPinError','Σφάλμα αλλαγής PIN'); }
    }

    async function loadUserManagement(){
      try{
        const snapshot = await db.collection('users').get();
        let html = '';
        snapshot.forEach(doc=>{
          const u = doc.data();
          html += `
            <div class="task-item">
              <div class="task-header">
                <div class="task-title">${u.name}</div>
                <div class="task-status ${u.isAdmin?'status-completed':'status-pending'}">${u.isAdmin?'👑 Admin':'👤 Χρήστης'}</div>
              </div>
              <div class="task-meta">
                <div>🔑 <strong>PIN:</strong> ••••</div>
                <div>📅 <strong>Τελευταία ενημέρωση:</strong> ${u.updatedAt ? u.updatedAt.toDate().toLocaleDateString('el-GR') : 'Ποτέ'}</div>
              </div>
            </div>`;
        });
        document.getElementById('userManagement').innerHTML = html;
      }catch(err){
        console.error('Error loading user management:', err);
        document.getElementById('userManagement').innerHTML = '<div class="error">Σφάλμα φόρτωσης χρηστών</div>';
      }
    }

    function switchTab(tabName){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');
      if(tabName==='admin' && isAdmin) loadUserManagement();
    }

    function showNotification(message){
      const n = document.createElement('div');
      n.className='notification-panel';
      n.innerHTML = `<button class="notification-close" onclick="this.parentElement.remove()">×</button>${message}`;
      document.body.appendChild(n);
      setTimeout(()=>{ if(n.parentElement){ n.remove(); } }, 5000);
    }

    function showError(id,message){
      document.getElementById(id).textContent = message;
      setTimeout(()=>{ document.getElementById(id).textContent=''; }, 5000);
    }

    window.onclick = function(e){
      const modal = document.getElementById('pinModal');
      if(e.target===modal) closePinModal();
    };

    // Προαιρετικό A2HS
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; showInstallButton(); });
    function showInstallButton(){
      const btn = document.createElement('button');
      btn.textContent='📱 Εγκατάσταση App';
      btn.className='btn';
      btn.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1000;';
      btn.onclick=()=>{
        if(deferredPrompt){
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(choice=>{ if(choice.outcome==='accepted'){ btn.remove(); } deferredPrompt=null; });
        }
      };
      document.body.appendChild(btn);
    }
  </script>
</body>
</html>
