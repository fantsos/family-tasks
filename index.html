<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Οικογενειακές Εργασίες · PWA</title>

  <!-- Manifest (embedded) -->
  <link
    rel="manifest"
    href='data:application/json,{
      "name":"Οικογενειακές Εργασίες",
      "short_name":"Εργασίες",
      "start_url":"./",
      "display":"standalone",
      "background_color":"#2e7d82",
      "theme_color":"#2e7d82",
      "prefer_related_applications":false,
      "icons":[
        {"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='32' fill='%232e7d82'/%3E%3Cpath d='M18 33l8 8 20-20' stroke='%23fff' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E","sizes":"64x64","type":"image/svg+xml","purpose":"maskable any"}
      ]
    }'
  />
  <meta name="theme-color" content="#2e7d82" />

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <style>
    :root{
      --brand:#2e7d82;
      --brand-2:#3d8b8f;
      --bg-grad:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --radius:18px;
      --soft-shadow: 0 20px 60px rgba(0,0,0,.2);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',sans-serif;min-height:100vh;background:var(--bg-grad);padding:20px}
    .container{max-width:900px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:var(--soft-shadow);overflow:hidden}
    .hidden{display:none !important}

    /* Header */
    .header{background:linear-gradient(135deg,var(--brand) 0%,var(--brand-2) 100%);padding:26px;color:#fff}
    .header h1{font-size:2rem}
    .user-info{margin-top:12px;display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .admin-badge{background:#ffd700;color:#333;padding:6px 10px;border-radius:999px;font-weight:700;font-size:.8rem}
    .header-buttons{display:flex;gap:8px}
    .btn-h{padding:8px 12px;border-radius:999px;border:2px solid rgba(255,255,255,.35);background:rgba(255,255,255,.15);backdrop-filter:blur(4px);color:#fff;cursor:pointer}

    /* Tabs */
    .main{padding:24px}
    .tabs{display:flex;gap:8px;background:#f5f7f9;border-radius:14px;padding:6px;flex-wrap:wrap}
    .tab{flex:1;text-align:center;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;color:#666}
    .tab.active{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;box-shadow:0 5px 15px rgba(46,125,130,.3)}

    /* Cards / forms */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:18px 0}
    .stat{background:#f5f7f9;border-radius:14px;padding:16px;text-align:center}
    .stat .n{font-size:1.6rem;font-weight:800;color:var(--brand)}
    .card{background:#f8f9fa;border:2px solid #edf0f3;border-radius:16px;padding:18px;box-shadow:0 5px 15px rgba(0,0,0,.06)}
    .grid{display:grid;gap:14px}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.resp{grid-template-columns:1fr}

    label{font-weight:700;color:var(--brand);font-size:.95rem}
    input, select, textarea{width:100%;padding:12px 14px;border:2px solid #e9ecef;border-radius:12px;font-size:1rem}
    input:focus, select:focus, textarea:focus{outline:none;border-color:var(--brand)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;border-radius:999px;cursor:pointer;padding:12px 20px;color:#fff;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
    .btn.s{padding:8px 12px;font-size:.9rem}
    .btn.gray{background:#6c757d}
    .btn.green{background:#28a745}
    .btn.red{background:#dc3545}
    .btn.yellow{background:#ffc107;color:#333}

    .task{background:#fff;border:2px solid #e9ecef;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 5px 15px rgba(0,0,0,.05)}
    .task .head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{font-weight:700;color:var(--brand)}
    .badge{border-radius:999px;padding:6px 10px;font-weight:700;font-size:.75rem}
    .b-pending{background:#fff3cd;color:#856404}
    .b-done{background:#d1ecf1;color:#0c5460}
    .meta{display:flex;gap:14px;flex-wrap:wrap;color:#666;font-size:.9rem;margin:8px 0}
    .desc{margin:10px 0;line-height:1.6}
    .thumb{max-width:100%;border-radius:10px;box-shadow:0 3px 12px rgba(0,0,0,.1)}

    .notice{position:fixed;right:20px;top:20px;background:var(--brand);color:#fff;padding:14px 16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:1000}

    @media (max-width: 820px){
      .grid.two{grid-template-columns:1fr}
      .stats{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <section id="login" class="card">
      <h2 style="color:var(--brand);font-size:1.6rem;margin-bottom:10px">🏠 Οικογενειακές Εργασίες</h2>
      <p style="color:#666;margin-bottom:16px">Επίλεξε χρήστη και PIN για είσοδο.</p>
      <div class="grid two">
        <div class="grid">
          <div class="actions">
            <button class="btn" data-user="dad">👨 Άρης</button>
            <button class="btn" data-user="mom">👩 Κατερίνα</button>
            <button class="btn" data-user="child">👧 Ελισάβετ</button>
          </div>
          <div>
            <label for="pin">PIN</label>
            <input id="pin" type="password" inputmode="numeric" maxlength="6" placeholder="π.χ. 1234"/>
            <small id="loginError" style="color:#dc3545"></small>
          </div>
          <div class="actions">
            <button id="loginBtn" class="btn">🔑 Είσοδος</button>
            <button id="installBtn" class="btn yellow" style="display:none">📲 Εγκατάσταση</button>
          </div>
          <small style="color:#666">🔥 Firebase + offline λειτουργία • 📢 Τοπικές ειδοποιήσεις</small>
        </div>
        <div class="grid">
          <div class="stat"><div class="n" id="statTotalLogin">0</div><div>Σύνολο εργασιών</div></div>
          <div class="stat"><div class="n" id="statPendingLogin">0</div><div>Εκκρεμείς</div></div>
          <div class="stat"><div class="n" id="statDoneLogin">0</div><div>Ολοκληρωμένες</div></div>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <header class="header">
        <h1>🏠 Οικογενειακές Εργασίες</h1>
        <div class="user-info">
          <div><strong id="who"></strong> <span id="badge" class="admin-badge hidden">ΔΙΑΧΕΙΡΙΣΤΗΣ</span> <span id="conn" class="admin-badge" style="background:#17a2b8">Έλεγχος…</span></div>
          <div class="header-buttons">
            <button id="btnPin" class="btn-h">🔑 PIN</button>
            <button id="btnLogout" class="btn-h">🚪 Έξοδος</button>
          </div>
        </div>
      </header>

      <main class="main">
        <div class="stats">
          <div class="stat"><div class="n" id="statTotal">0</div><div>Σύνολο</div></div>
          <div class="stat"><div class="n" id="statPending">0</div><div>Εκκρεμείς</div></div>
          <div class="stat"><div class="n" id="statDone">0</div><div>Ολοκληρωμένες</div></div>
        </div>

        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="current">📋 Τρέχουσες</button>
          <button class="tab" data-tab="history">📚 Ιστορικό</button>
          <button id="tabAdmin" class="tab hidden" data-tab="admin">⚙️ Διαχείριση</button>
        </div>

        <!-- Current -->
        <section id="tab-current" class="grid" role="tabpanel">
          <section class="card grid">
            <h3>📝 Νέα Εργασία</h3>
            <div class="grid two">
              <div>
                <label>Τίτλος</label>
                <input id="taskTitle" placeholder="π.χ. Καθάρισμα δωματίου" />
              </div>
              <div>
                <label>Ανάθεση σε</label>
                <select id="assignedTo">
                  <option value="">Επιλέξτε άτομο</option>
                  <option value="dad">👨 Άρης</option>
                  <option value="mom">👩 Κατερίνα</option>
                  <option value="child">👧 Ελισάβετ</option>
                </select>
              </div>
              <div>
                <label>Περιγραφή</label>
                <textarea id="taskDescription" rows="3" placeholder="Λεπτομέρειες..."></textarea>
              </div>
              <div class="grid">
                <div>
                  <label>Προτεραιότητα</label>
                  <select id="taskPriority">
                    <option value="low">Χαμηλή</option>
                    <option value="medium" selected>Μέτρια</option>
                    <option value="high">Υψηλή</option>
                  </select>
                </div>
                <div>
                  <label>Προθεσμία</label>
                  <input id="taskDue" type="datetime-local" />
                </div>
              </div>
              <div>
                <label>📷 Φωτογραφία (προαιρετική)</label>
                <input id="taskPhoto" type="file" accept="image/*" capture="environment" />
                <div id="photoPreview" style="margin-top:8px"></div>
              </div>
            </div>
            <div class="actions">
              <button id="btnCreate" class="btn">✨ Δημιουργία</button>
            </div>
          </section>

          <section>
            <h3 style="color:var(--brand);margin-bottom:8px">📋 Εκκρεμείς</h3>
            <div id="tasks"></div>
          </section>
        </section>

        <!-- History -->
        <section id="tab-history" class="hidden" role="tabpanel">
          <h3 style="color:var(--brand);margin-bottom:8px">📚 Ολοκληρωμένες</h3>
          <div id="history"></div>
        </section>

        <!-- Admin -->
        <section id="tab-admin" class="hidden" role="tabpanel">
          <section class="card">
            <h3>⚙️ Διαχείριση χρηστών</h3>
            <div id="users"></div>
          </section>
          <section class="card" style="margin-top:14px">
            <h3>🛠️ Μετατροπή παλιών εργασιών</h3>
            <p style="color:#666;margin:8px 0">Προσθέτει το πεδίο <code>participants</code> (π.χ. [assignedTo, assignedBy]) σε παλιές εργασίες ώστε να φαίνονται στα νέα queries.</p>
            <div class="actions"><button id="btnMigrate" class="btn">🔄 Μετατροπή παλιών εργασιών</button></div>
          </section>
        </section>
      </main>
    </section>
  </div>

  <!-- Simple modal for PIN changes -->
  <dialog id="pinDialog" style="border:none;border-radius:16px;padding:0;max-width:440px;width:95%">
    <form method="dialog" class="card">
      <h3>🔑 Διαχείριση PIN</h3>
      <div id="pinForm" class="grid" style="margin-top:10px"></div>
      <div class="actions" style="margin-top:12px;justify-content:flex-end">
        <button class="btn gray" value="cancel">Άκυρο</button>
      </div>
    </form>
  </dialog>

  <!-- Notifications -->
  <div id="notice" class="notice hidden"></div>

  <script>
    // === CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyC1FnOEYHlBaXQtxqHX9Qnwx4lpZc0cZY0",
      authDomain: "family-tasks-app-44296.firebaseapp.com",
      projectId: "family-tasks-app-44296",
      storageBucket: "family-tasks-app-44296.firebasestorage.app",
      messagingSenderId: "108479351489",
      appId: "1:108479351489:web:0629b17053ec0eeb96e240",
    };

    // === INIT ===
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Enable offline persistence (best effort)
    db.enablePersistence({ synchronizeTabs: true }).catch(() => {});

    const NAMES = { dad: "👨 Άρης", mom: "👩 Κατερίνα", child: "👧 Ελισάβετ" };
    const COLORS = { low: "#28a745", medium: "#ffc107", high: "#dc3545" };

    let userId = localStorage.getItem('ft_user') || null;
    let isAdmin = false;

    // PWA install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBtn').style.display = 'inline-block';
    });
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('installBtn').style.display = 'none';
    });

    // Service worker (single-file via Blob)
    if ('serviceWorker' in navigator) {
      const swCode = `self.addEventListener('install', e=>{e.waitUntil(caches.open('ft-v1').then(c=>c.addAll(['./'])))});
self.addEventListener('fetch', e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))});`;
      const blobURL = URL.createObjectURL(new Blob([swCode], { type: 'text/javascript' }));
      navigator.serviceWorker.register(blobURL);
    }

    // Simple local notice
    const showNotice = (msg) => {
      const el = document.getElementById('notice');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(()=> el.classList.add('hidden'), 4000);
    };

    // Local Notification API (permission ask once)
    const ensureNotiPerm = async () => {
      if (!('Notification' in window)) return false;
      if (Notification.permission === 'granted') return true;
      if (Notification.permission !== 'denied') {
        const p = await Notification.requestPermission();
        return p === 'granted';
      }
      return false;
    };

    // Connectivity ping
    async function pingFirebase(){
      const el = document.getElementById('conn');
      if(!el) return;
      try{
        await db.collection('_status').doc('ping').set({
          at: firebase.firestore.FieldValue.serverTimestamp(),
          by: userId || 'unknown'
        },{ merge: true });
        const d = await db.collection('_status').doc('ping').get();
        if(d.exists){ el.textContent='🟢 Firebase OK'; el.style.background='#28a745'; }
        else { el.textContent='🟡 Firebase'; el.style.background='#ffc107'; }
      }catch(e){ console.error(e); el.textContent='🔴 Χωρίς σύνδεση'; el.style.background='#dc3545'; }
    }

    // === UI helpers ===
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // Login screen bindings
    $$('#login .btn[data-user]').forEach((b) => b.addEventListener('click', () => {
      $$('#login .btn[data-user]').forEach(x=>x.classList.remove('yellow'));
      b.classList.add('yellow');
      userId = b.getAttribute('data-user');
    }));

    $('#loginBtn').addEventListener('click', login);
    $('#pin').addEventListener('keypress', (e)=>{ if(e.key==='Enter') login(); });

    async function login(){
      const pin = $('#pin').value.trim();
      const err = $('#loginError');
      err.textContent = '';
      if(!userId){ err.textContent = 'Επίλεξε χρήστη'; return; }
      if(!pin){ err.textContent = 'Βάλε PIN'; return; }
      try{
        // Get user doc
        const doc = await db.collection('users').doc(userId).get();
        if(!doc.exists){ err.textContent = 'Ο χρήστης δεν υπάρχει'; return; }
        const data = doc.data();
        // NOTE: For production, store ONLY a salted hash. Here we compare plain PIN for simplicity.
        if(data.pin !== pin){ err.textContent = 'Λάθος PIN'; return; }

        await auth.signInAnonymously();
        isAdmin = !!data.isAdmin;
        localStorage.setItem('ft_user', userId);
        $('#who').textContent = NAMES[userId];
        $('#badge').classList.toggle('hidden', !isAdmin);
        $('#tabAdmin').classList.toggle('hidden', !isAdmin);
        $('#login').classList.add('hidden');
        $('#app').classList.remove('hidden');

        // listeners
        startTaskListeners();
        loadUsers();
        ensureNotiPerm();
        pingFirebase();
      }catch(e){ err.textContent = 'Σφάλμα σύνδεσης'; console.error(e); }
    }

    $('#btnLogout').addEventListener('click', async ()=>{
      await auth.signOut();
      localStorage.removeItem('ft_user');
      location.reload();
    });

    // Tabs
    $$('.tab').forEach(t=> t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['current','history','admin'].forEach(name=>{
        const on = t.dataset.tab===name;
        document.getElementById('tab-'+name)?.classList.toggle('hidden', !on);
      });
      if(t.dataset.tab==='admin') loadUsers();
    }));

    // New task
    const photoInput = $('#taskPhoto');
    photoInput.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      const prev = $('#photoPreview');
      if(!f){ prev.innerHTML=''; return; }
      const reader = new FileReader();
      reader.onload = (ev)=> prev.innerHTML = `<img class="thumb" alt="preview" src="${ev.target.result}"/>`;
      reader.readAsDataURL(f);
    });

    $('#btnCreate').addEventListener('click', addTask);

    async function addTask(){
      const title = $('#taskTitle').value.trim();
      const assignedTo = $('#assignedTo').value;
      const description = $('#taskDescription').value.trim();
      const priority = $('#taskPriority').value || 'medium';
      const dueRaw = $('#taskDue').value;

      if(!title || !assignedTo){ showNotice('Συμπλήρωσε τίτλο και παραλήπτη'); return; }

      // upload photo (if any) to Firebase Storage
      let photoURL = null;
      const file = photoInput.files?.[0];
      if(file){
        const ref = storage.ref().child(`task_photos/${Date.now()}_${file.name}`);
        await ref.put(file);
        photoURL = await ref.getDownloadURL();
      }

      const task = {
        title, description, assignedTo, assignedBy: userId, priority,
        status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        completedAt: null, photoURL,
        participants: [assignedTo, userId],
        dueAt: dueRaw ? firebase.firestore.Timestamp.fromDate(new Date(dueRaw)) : null
      };

      try{
        await db.collection('tasks').add(task);
        ['taskTitle','taskDescription','assignedTo','taskPriority','taskDue'].forEach(id=>{ const el=document.getElementById(id); if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; });
        $('#photoPreview').innerHTML='';
        photoInput.value='';
        notifyNewTask(assignedTo, title);
      }catch(e){ console.error(e); showNotice('❌ Σφάλμα προσθήκης'); }
    }

    async function notifyNewTask(to, title){
      if(to!==userId && ('Notification' in window) && Notification.permission==='granted'){
        new Notification('🆕 Νέα εργασία', { body: `${title} → ${NAMES[to]}` });
      }
      showNotice(`Η εργασία «${title}» ανατέθηκε στον/στη ${NAMES[to]}!`);
    }

    // Real-time listeners (use participants array to reduce reads)
    let unsub = [];
    function clearUnsub(){ unsub.forEach(u=>u&&u()); unsub=[]; }

    function startTaskListeners(){
      clearUnsub();
      const itemsMap = new Map();
      const handle = (snap)=>{
        snap.docChanges().forEach(ch=>{
          if(ch.type==='removed') itemsMap.delete(ch.doc.id);
          else itemsMap.set(ch.doc.id, { id: ch.doc.id, ...ch.doc.data() });
        });
        const items = Array.from(itemsMap.values()).sort((a,b)=>{
          const ta = a.createdAt?.toMillis?.()||0; const tb = b.createdAt?.toMillis?.()||0; return tb-ta;
        });
        renderTasks(items);
        renderHistory(items);
        updateStats(items);
      };
      const onErr = (e)=>{ console.error('Listener error', e); showNotice('⚠️ Σφάλμα ανάγνωσης (Rules/Index). Δες Διαχείριση → Μετατροπή.'); const c=document.getElementById('conn'); if(c){c.textContent='⚠️ Σφάλμα'; c.style.background='#dc3545';} };

      // New schema
      unsub.push(
        db.collection('tasks')
          .where('participants','array-contains', userId)
          .onSnapshot(handle, onErr)
      );
      // Legacy fallbacks
      unsub.push(
        db.collection('tasks')
          .where('assignedTo','==', userId)
          .onSnapshot(handle, onErr)
      );
      unsub.push(
        db.collection('tasks')
          .where('assignedBy','==', userId)
          .onSnapshot(handle, onErr)
      );

      // If after a while no items, hint migration
      setTimeout(()=>{
        if(itemsMap.size===0){
          const el = document.getElementById('tasks');
          if(el) el.innerHTML = `<div style="text-align:center;color:#666;padding:28px">Δεν βρέθηκαν εργασίες για τον χρήστη. <br/>👉 Έλεγξε το <strong>firebaseConfig</strong> και δοκίμασε από το <strong>⚙️ Διαχείριση</strong> το «Μετατροπή παλιών εργασιών».</div>`;
        }
      }, 2000);
    }

    function updateStats(items){
      const total = items.length;
      const pending = items.filter(t=>t.status==='pending').length;
      const done = total - pending;
      ['statTotal','statPending','statDone','statTotalLogin','statPendingLogin','statDoneLogin']
        .forEach((id,i)=>{
          const val = [total,pending,done][i%3];
          const el = document.getElementById(id);
          if(el) el.textContent = val;
        });
    }

    function fmtDate(ts){
      try{ return ts?.toDate().toLocaleString('el-GR'); }catch{return ''}
    }

    function priorityText(p){ return p==='high'?'Υψηλή':(p==='medium'?'Μέτρια':'Χαμηλή'); }

    function renderTasks(items){
      const el = $('#tasks');
      const mine = items.filter(t=>t.status==='pending');
      if(mine.length===0){ el.innerHTML = `<div style="text-align:center;color:#666;padding:28px">Δεν υπάρχουν εκκρεμείς 🎉<br/>Αν περίμενες να δεις παλιές εργασίες: 1) έλεγξε το <strong>firebaseConfig</strong>, 2) πήγαινε «⚙️ Διαχείριση» → «Μετατροπή παλιών εργασιών».</div>`; return; }
      el.innerHTML = mine.map(task=>{
        const due = task.dueAt ? `🗓️ <strong>Προθεσμία:</strong> ${fmtDate(task.dueAt)}` : '';
        return `<div class="task" data-id="${task.id}">
          <div class="head">
            <div class="title">${escapeHTML(task.title)}</div>
            <span class="badge b-pending">⏳ Εκκρεμεί</span>
          </div>
          <div class="meta">
            <div>🎯 <strong>Από:</strong> ${NAMES[task.assignedBy]}</div>
            <div>👤 <strong>Σε:</strong> ${NAMES[task.assignedTo]}</div>
            <div>⭐ <strong>Προτεραιότητα:</strong> <span style="color:${COLORS[task.priority]}">${priorityText(task.priority)}</span></div>
            ${task.createdAt?`<div>📅 ${fmtDate(task.createdAt)}</div>`:''}
            ${due?`<div>${due}</div>`:''}
          </div>
          ${task.description?`<div class="desc">${escapeHTML(task.description)}</div>`:''}
          ${task.photoURL?`<img class="thumb" alt="Φωτογραφία εργασίας" src="${task.photoURL}">`:''}
          <div class="actions">
            ${task.assignedTo===userId?`<button class="btn s green" data-act="done">✅ Ολοκλήρωση</button>`:''}
            ${(task.assignedBy===userId||isAdmin)?`<button class="btn s red" data-act="delete">🗑️ Διαγραφή</button>`:''}
            ${(task.assignedBy===userId||isAdmin)?`<button class="btn s gray" data-act="edit">✏️ Επεξεργασία</button>`:''}
          </div>
        </div>`;
      }).join('');
      // bind actions
      el.querySelectorAll('[data-act]')?.forEach(btn=> btn.addEventListener('click', onTaskAction));
    }

    async function onTaskAction(e){
      const btn = e.currentTarget;
      const act = btn.getAttribute('data-act');
      const wrap = btn.closest('.task');
      const id = wrap.getAttribute('data-id');
      if(act==='done'){
        await db.collection('tasks').doc(id).update({ status:'completed', completedAt: firebase.firestore.FieldValue.serverTimestamp() });
        showNotice('🎉 Ολοκληρώθηκε!');
      }else if(act==='delete'){
        if(confirm('Σίγουρα;')){ await db.collection('tasks').doc(id).delete(); showNotice('🗑️ Διαγράφηκε'); }
      }else if(act==='edit'){
        editTask(id);
      }
    }

    async function editTask(id){
      const ref = db.collection('tasks').doc(id);
      const snap = await ref.get();
      if(!snap.exists) return;
      const t = snap.data();
      // Simple inline prompt-based edit (minimal UI without extra framework)
      const title = prompt('Τίτλος', t.title) ?? t.title;
      const description = prompt('Περιγραφή', t.description||'') ?? t.description;
      const priority = prompt('Προτεραιότητα (low|medium|high)', t.priority) ?? t.priority;
      await ref.update({ title, description, priority });
      showNotice('✏️ Αποθηκεύτηκε');
    }

    function renderHistory(items){
      const el = $('#history');
      const done = items.filter(t=>t.status==='completed').slice(0,50);
      if(done.length===0){ el.innerHTML = `<div style="text-align:center;color:#666;padding:28px">Δεν υπάρχουν ολοκληρωμένες.</div>`; return; }
      el.innerHTML = done.map(task=>{
        const completed = task.completedAt ? fmtDate(task.completedAt) : '';
        let days = '';
        try{
          const c = task.completedAt?.toDate()?.getTime?.()||0;
          const s = task.createdAt?.toDate()?.getTime?.()||0;
          if(c&&s){ const d = Math.round((c-s)/86400000); days = d===0? 'Ίδια μέρα':''+d+' μέρες'; }
        }catch{}
        return `<div class="task" style="border-color:#c3e6cb;background:#f8f9fa">
          <div class="head"><div class="title">${escapeHTML(task.title)}</div><span class="badge b-done">✅ Ολοκληρώθηκε</span></div>
          <div class="meta">
            <div>🎯 <strong>Από:</strong> ${NAMES[task.assignedBy]}</div>
            <div>👤 <strong>Σε:</strong> ${NAMES[task.assignedTo]}</div>
            ${days?`<div>⏰ <strong>Χρόνος:</strong> ${days}</div>`:''}
            ${completed?`<div>📅 <strong>Ολοκληρώθηκε:</strong> ${completed}</div>`:''}
          </div>
          ${task.description?`<div class="desc">${escapeHTML(task.description)}</div>`:''}
          ${task.photoURL?`<img class="thumb" alt="Φωτογραφία" src="${task.photoURL}">`:''}
        </div>`;
      }).join('');
    }

    // PIN dialog
    $('#btnPin').addEventListener('click', ()=>{
      const dlg = document.getElementById('pinDialog');
      const host = document.getElementById('pinForm');
      if(isAdmin){
        host.innerHTML = `
          <label>Χρήστης</label>
          <select id="pinUser">
            <option value="dad">👨 Άρης</option>
            <option value="mom">👩 Κατερίνα</option>
            <option value="child">👧 Ελισάβετ</option>
          </select>
          <label>Νέο PIN</label>
          <input id="pinNew" type="password" maxlength="6" />
          <label>Επιβεβαίωση</label>
          <input id="pinConfirm" type="password" maxlength="6" />
          <div class="actions"><button id="btnAdminPin" class="btn">Αλλαγή PIN</button></div>
        `;
        setTimeout(()=> document.getElementById('btnAdminPin').onclick = changeUserPinAsAdmin, 0);
      }else{
        host.innerHTML = `
          <label>Τρέχον PIN</label>
          <input id="pinCur" type="password" />
          <label>Νέο PIN</label>
          <input id="pinNew" type="password" maxlength="6" />
          <label>Επιβεβαίωση</label>
          <input id="pinConfirm" type="password" maxlength="6" />
          <div class="actions"><button id="btnSelfPin" class="btn">Αλλαγή PIN</button></div>
        `;
        setTimeout(()=> document.getElementById('btnSelfPin').onclick = changeUserPin, 0);
      }
      dlg.showModal();
    });

    async function changeUserPin(){
      const cur = document.getElementById('pinCur').value;
      const n1 = document.getElementById('pinNew').value;
      const n2 = document.getElementById('pinConfirm').value;
      if(!(n1&&n2) || n1!==n2 || n1.length<4){ showNotice('Έλεγχος PIN: τουλάχιστον 4 ψηφία & ίδια.'); return; }
      const doc = await db.collection('users').doc(userId).get();
      if(!doc.exists || doc.data().pin !== cur){ showNotice('Λάθος τρέχον PIN'); return; }
      await db.collection('users').doc(userId).update({ pin:n1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      showNotice('🔑 Αλλαγή PIN επιτυχής');
      document.getElementById('pinDialog').close();
    }

    async function changeUserPinAsAdmin(){
      const uid = document.getElementById('pinUser').value;
      const n1 = document.getElementById('pinNew').value;
      const n2 = document.getElementById('pinConfirm').value;
      if(!(n1&&n2) || n1!==n2 || n1.length<4){ showNotice('Έλεγχος PIN: τουλάχιστον 4 ψηφία & ίδια.'); return; }
      await db.collection('users').doc(uid).update({ pin:n1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      showNotice('🔑 PIN άλλαξε');
      document.getElementById('pinDialog').close();
    }

    // Admin list
    async function loadUsers(){
      if(!isAdmin) return;
      const host = document.getElementById('users');
      const snap = await db.collection('users').get();
      host.innerHTML = '';
      snap.forEach(d=>{
        const u = d.data();
        host.innerHTML += `<div class="task"><div class="head"><div class="title">${u.name}</div><span class="badge ${u.isAdmin?'b-done':'b-pending'}">${u.isAdmin?'👑 Admin':'👤 Χρήστης'}</span></div><div class="meta"><div>📅 Τελευταία ενημέρωση: ${u.updatedAt?fmtDate(u.updatedAt):'—'}</div></div></div>`;
      });
    }

    // One-off migration tool (admin)
    async function migrateLegacy(){
      if(!isAdmin){ showNotice('Μόνο για διαχειριστές'); return; }
      if(!confirm('Θα προστεθεί το πεδίο participants όπου λείπει. Συνέχεια;')) return;
      try{
        const snap = await db.collection('tasks').get();
        let updated = 0;
        for(const doc of snap.docs){
          const t = doc.data();
          if(!t.participants || !Array.isArray(t.participants) || t.participants.length===0){
            const p = Array.from(new Set([t.assignedTo, t.assignedBy].filter(Boolean)));
            await doc.ref.update({ participants: p });
            updated++;
          }
        }
        showNotice(`Ολοκληρώθηκε η μετατροπή σε ${updated} εργασίες.`);
        // refresh listeners
        startTaskListeners();
      }catch(e){ console.error(e); showNotice('❌ Σφάλμα στο migration'); }
    }

    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id==='btnMigrate') migrateLegacy();
    });

    // Escape HTML simple util
    function escapeHTML(str=''){
      return str.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
    }

    // === SECURITY (IMPORTANT) ===
    // For production:
    // 1) ΜΗΝ αποθηκεύεις PIN σε καθαρό κείμενο. Αποθήκευση μόνο salted hash (π.χ. με Cloud Functions)
    // 2) Firestore rules ώστε κάθε χρήστης να βλέπει μόνο tasks όπου participants περιέχει το uid του.
    //    Παράδειγμα:
    //    rules_version = '2';
    //    service cloud.firestore {
    //      match /databases/{database}/documents {
    //        match /tasks/{taskId} {
    //          allow read, update, delete: if request.auth != null && request.resource.data.participants.hasOnly(request.auth.token.customUserId) == false && request.resource.data.participants.size() > 0;
    //          allow create: if request.auth != null;
    //        }
    //        match /users/{userId} {
    //          allow read, update: if request.auth != null && request.auth.token.customUserId == userId;
    //        }
    //      }
    //    }
    // 3) Ιδανικά χρήσε Firebase Auth (email/pass ή passkeys) αντί για PIN.

  </script>
</body>
</html>
